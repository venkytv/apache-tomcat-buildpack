#!/usr/bin/env ruby
# bin/compile <build-dir> <cache-dir>

require 'digest/md5'
require 'fileutils'
require 'open-uri'
require 'yaml'

BUILDDIR = ARGV.shift
CACHEDIR = ARGV.shift
BUILDPACKDIR = File.dirname(File.dirname(File.expand_path $0))
TMPDIR = ENV['TMPDIR'] || '/tmp'
ORIGDIR = Dir.getwd
CHECKSUMFILE = File.join(BUILDPACKDIR, 'bundles.md5sum')

puts "==========
Build dir: #{BUILDDIR}
Cache dir: #{CACHEDIR}
Buildpack dir: #{BUILDPACKDIR}
Temp dir: #{TMPDIR}
=========="

# Load config from buildpack
configfile = File.join(BUILDPACKDIR, 'config.yml')
abort "Config file not found: #{configfile}" unless configfile
puts "Loading config file: #{configfile}"
config = YAML.load(File.read(configfile))

# Extend Hash to support deep merging of two hashes.  The default "merge"
# routine only merges the top level keys.
class ::Hash
    def deep_merge(second)
        merger = proc { |key, v1, v2| Hash === v1 && Hash === v2 ? v1.merge(v2, &merger) : v2 }
        self.merge(second, &merger)
    end
end

# Load config_override.yml from cf pushed directory, if available
override_configfile = File.join(BUILDDIR, 'config_override.yml')
if (File.exists?(override_configfile))
    override_config = YAML.load(File.read(override_configfile))
    config = config.deep_merge(override_config)
else
    override_configfile = nil
end

# Load checksums
puts "Loading checksums"
checksums = {}
File.open(CHECKSUMFILE) do |f|
    f.readlines.each do |line|
        (sum, file) = line.split(/\s+/)
        checksums[file] = sum
    end
end

# Download bundles
puts "Downloading bundles"
config['bundles'].each do |bundlename, bundle|
    filename = bundle['filename']
    location = bundle['location']
    checksum = checksums[filename]

    # Try and load file from cache
    cachedir = File.join(CACHEDIR, checksum)
    cachefile = File.join(cachedir, filename)
    location = cachefile if File.exists?(cachefile)

    puts "Getting bundle #{filename} from #{location}"

    tmpfile = File.join(TMPDIR, bundle['filename'])
    open(tmpfile, 'w') do |outfile|
        open(location) do |infile|
            outfile.write(infile.read)
        end
    end

    # Verify MD5 sum
    if (checksum)
        gotsum = Digest::MD5.hexdigest(File.read(tmpfile))
        abort "MD5 sum mismatch: #{filename}" unless gotsum == checksum
        puts "MD5 check: OK"
    else
        puts "Skipping checksum verification for #{filename}"
    end

    # Cache the downloaded bundle
    if (config['options']['cache_binaries'] and not File.exists?(cachefile))
        puts "Caching file: #{filename}"
        Dir.mkdir cachedir unless File.directory? cachedir
        FileUtils.copy(tmpfile, cachefile)
    end

    # Unbundle into build directory
    puts "Unbundling #{filename}"
    Dir.chdir BUILDDIR
    system('tar', 'xf', tmpfile) \
        or abort "Failed to unbundle #{filename}"
    FileUtils.rm tmpfile
    Dir.chdir ORIGDIR
end

[ File.join(BUILDPACKDIR, 'bin', 'boot.rb'), configfile ].each do |infile|
    outfile = File.join(BUILDDIR, File.basename(infile))
    unless (File.identical?(infile, outfile))
        puts "Copying over file #{infile}"
        FileUtils.copy(infile, outfile)
    end
end

if (override_configfile)
    outfile = File.join(BUILDDIR, File.basename(override_configfile))
    unless (File.identical?(override_configfile, outfile))
        puts "Copying over file #{override_configfile}"
        FileUtils.copy(override_configfile, outfile)
    end
end

puts "Copying over templates"
templates = File.join(BUILDPACKDIR, 'templates')
FileUtils.cp_r(templates, BUILDDIR)

# vim: set tabstop=4 shiftwidth=4 expandtab :
