#!/usr/bin/env ruby
# bin/compile <build-dir> <cache-dir>

require 'fileutils'
require 'yaml'

BUILDDIR = ARGV.shift
CACHEDIR = ARGV.shift

config = {}
configfile = File.join(ENV['HOME'], 'config.yml')
if (File.exists?(configfile))
    config = YAML.load(File.read(configfile))
end

Dir.chdir(BUILDDIR)

# Clear out the build directory
Dir['*'].each do |dir|
    puts "Removing #{BUILDDIR}/#{dir}"
    FileUtils.rm_r dir
end

# Unbundle packages into build directory
bundles = config['bundles'].collect {|d| [ d,  1 ] }
bundles = Hash[*bundles.flatten]

all_bundles = File.join(ENV['HOME'], 'vendor', 'bundles', '*')
Dir[all_bundles].each do |bundle|
    bundlename = File.basename(bundle, '.tar.bz2')
	if (bundles[bundlename])
        puts "Unbundling #{bundlename}"
        system('tar', 'xf', bundle) \
            or abort "Failed to unbundle #{bundle}"
    else
        puts "Skipping #{bundle}"
    end
end

[ File.join('bin', 'boot.rb'), 'config.yml' ].each do |file|
    infile = File.join(ENV['HOME'], file)
    puts "Copying in file #{infile}"
    FileUtils.copy(infile, '.')
end

# vim: set tabstop=4 shiftwidth=4 expandtab :
